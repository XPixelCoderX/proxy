<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="icon" type="image/x-icon" href="/img/favicon.ico" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StrongDog XP</title>
    <link rel="stylesheet" href="assets/styles.css" />

    <style>
      .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }
      .popup-container {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        justify-content: center;
        align-items: center;
        z-index: 1001;
      }
      .popup-container.active {
        display: flex;
      }
      .popup {
        background-color: #333;
        color: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        max-width: 90%;
        width: 300px;
        text-align: center;
      }
      .popup button {
        margin-top: 20px;
        padding: 10px 20px;
        background-color: #ff8c00;
        border: none;
        color: white;
        font-size: 14px;
        border-radius: 5px;
        cursor: pointer;
      }
      .popup button:hover {
        background-color: #ff6a00;
      }
    </style>

    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

    <script
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1609993827735056"
      crossorigin="anonymous"
    ></script>

    <script>
      const polytrackKeys = [
        "v1_record_445edfa992d0b19b376c8072692f69eafc4afeceb608ba355d44b3cb57a902a0",
        "v1_record_55a26267e4fa6a176ba5898b3e1354d54bbf7c02ed0fd3f37e4e3cee56724a8a",
        "v1_record_60b9020ffd46fa428ce40ab2e610992d4bcd2df68f00005c6b88544ce134f950",
        "v1_record_764e05d5eb827c3b608b288cdffc3dc29be2abcc5d29cf958b029badf1564417",
        "v1_record_8b4383a77d1f900b5beff053aee8a1bc47a733778dac54f6ecca0dd6cffeec80",
        "v1_record_ed65907f59ece7a863e9f1ea1e2b50714920899f7d2e42d9b9656bcb8382b66a",
        "v1_record_f67a25877dbbdb5287f9191cda506a254b0ca7a95fde82e34951fe55bb04c172",
      ];
      const babelTowerKeys = [
        "Tower_id",
        "W_3_numGiftsAlreadyGiven",
        "W_3_timeOfNextGift",
        "save_version",
        "save_date",
        "save_data",
      ];
      const idleSharkKey = ["sharkGameSave"];
      const cookieClickerKey = ["CookieClickerGame"];
      const badEggKeys = [
        "vms--u",
        "vms--logger-settings",
        "vms--reload-manager-enabled",
        "vms--mod-geo",
        "vms--vm-abd",
      ];

      function getParsedItem(key) {
        const item = localStorage.getItem(key);
        try {
          return JSON.parse(item);
        } catch (error) {
          console.warn(`Invalid JSON for key: ${key} Error: ${error}`);
          return item;
        }
      }

      function copyText(text) {
        navigator.clipboard
          .writeText(text)
          .then(() => showTransferInstructions())
          .catch((err) =>
            alert(`Error: failed to copy your save data: ${err}`)
          );
      }

      function showTransferInstructions() {
        alert(
          "Your save data was successfully copied to your clipboard!\n" +
            "To transfer your save data to either strongdogxp.github.io or mathcordxp.github.io, " +
            "navigate to the home page of either website and in the red updates box, " +
            "you'll see instructions to import your data.\n\n" +
            "DON'T overwrite your clipboard before you import!"
        );
      }

      function setDataInObject(dataObj) {
        Object.entries(dataObj).forEach(([key, value]) => {
          if (value !== null) {
            const finalValue =
              typeof value === "string" ? value : JSON.stringify(value);
            localStorage.setItem(key, finalValue);
          }
        });
      }

      function validateData(dataObj) {
        return Object.values(dataObj).every((value) => value !== null);
      }

      function getAndBundleDataIntoObj(keysArr) {
        const dataObj = Object.fromEntries(
          keysArr.map((key) => [key, getParsedItem(key)])
        );
        if (!validateData(dataObj))
          alert(
            "(If retrieving Polytrack saves, that might be ok.)\n\nSome keys " +
              "could not be retrieved. If you notice issues, ensure all keys exist in localStorage " +
              "and try again, or contact us on Discord."
          );
        return JSON.stringify(dataObj);
      }

      function getDataAndCopy(keysArr) {
        const gameData = getAndBundleDataIntoObj(keysArr);
        if (gameData) copyText(gameData);
      }

      document.addEventListener("DOMContentLoaded", function () {
        if (window.location.hostname.includes("netlify.app")) {
          document.body.innerHTML = `
            <div style="padding: 20px; text-align: center; color: white; background-color: #333; font-family: Arial, sans-serif;">
              <p>Hi there! If you're seeing this, you're trying to connect to a StrongDog version hosted on Netlify. Due to Netlify's costs, we moved back to GitHub with updated links!</p>
              <p>Use these new links going forward:</p>
              <p><a href="https://strongdogxp.github.io" style="color: orange;">strongdogxp.github.io</a></p>
              <p><a href="https://mathcordxp.github.io" style="color: orange;">mathcordxp.github.io</a></p>
              <p>If you used <strong>stroongdog.netlify.app</strong>, the updated GitHub link is on Discord in the same place the original was posted.</p>
              <h2>Use these buttons to copy your save data from Netlify to your new site:</h2>
              <button id="get-polytrack-data" style="background: orange; border-radius: 10px; padding: 1em; color: black; border: none; cursor: pointer;">Retrieve Polytrack Save Data</button>
              <button id="get-cookie-clicker-data" style="background: orange; border-radius: 10px; padding: 1em; color: black; border: none; cursor: pointer;">Retrieve Cookie Clicker Save Data</button>
              <button id="get-bad-egg-data" style="background: orange; border-radius: 10px; padding: 1em; color: black; border: none; cursor: pointer;">Retrieve Bad Egg Save Data</button>
              <button id="get-babel-tower-data" style="background: orange; border-radius: 10px; padding: 1em; color: black; border: none; cursor: pointer;">Retrieve Babel Tower Save Data</button>
              <button id="get-idle-shark-data" style="background: orange; border-radius: 10px; padding: 1em; color: black; border: none; cursor: pointer;">Retrieve Idle Shark Save Data</button>
              <p>If these buttons don't work or you're unsure, message us on Discord.</p>
              <h2><strong>DON'T FORGET TO UPDATE YOUR BOOKMARKS! This page will be gone soon!</strong></h2>
            </div>
          `;
          document.body.style =
            "height: 100vh; margin: 0; display: grid; place-items: center;";

          const getPolytrackDataBtn =
            document.getElementById("get-polytrack-data");
          const getCookieClickerDataBtn = document.getElementById(
            "get-cookie-clicker-data"
          );
          const getBadEggDataBtn = document.getElementById("get-bad-egg-data");
          const getBabelTowerDataBtn = document.getElementById(
            "get-babel-tower-data"
          );
          const getIdleSharkDataBtn = document.getElementById(
            "get-idle-shark-data"
          );

          getPolytrackDataBtn.addEventListener("click", () =>
            getDataAndCopy(polytrackKeys)
          );
          getCookieClickerDataBtn.addEventListener("click", () =>
            getDataAndCopy(cookieClickerKey)
          );
          getBadEggDataBtn.addEventListener("click", () =>
            getDataAndCopy(badEggKeys)
          );
          getBabelTowerDataBtn.addEventListener("click", () =>
            getDataAndCopy(babelTowerKeys)
          );
          getIdleSharkDataBtn.addEventListener("click", () =>
            getDataAndCopy(idleSharkKey)
          );
        } else {
          const importSaveDataBtn = document.getElementById(
            "import-save-data-btn"
          );
          if (importSaveDataBtn) {
            importSaveDataBtn.addEventListener("click", () => {
              const confirmMessage = confirm(
                `IMPORTANT: By confirming, you OVERWRITE ALL local saves for the relevant game.\n` +
                  `If you want to keep your current local data, press CANCEL.\n\n` +
                  `After closing this dialog, your browser may ask permission to read your clipboard. ` +
                  `You MUST allow it to import your data.`
              );
              if (!confirmMessage) return;

              navigator.clipboard
                .readText()
                .then((text) => {
                  if (!text) {
                    throw new Error(
                      "Clipboard is empty. Copy your data first!"
                    );
                  }
                  let parsedData;
                  try {
                    parsedData = JSON.parse(text);
                  } catch (err) {
                    throw new Error("Clipboard data is not valid JSON.");
                  }
                  if (typeof parsedData !== "object") {
                    throw new Error("Invalid data format in your clipboard.");
                  }
                  setDataInObject(parsedData);
                  alert(
                    "Your data was successfully imported! If there are any issues, please contact support."
                  );
                })
                .catch((err) =>
                  alert(`Failed to read clipboard contents: ${err}`)
                );
            });
          }
        }
      });
    </script>

    <script>
      window.siteMapping = {
        "strongdogxp.github.io": [
          "https://strongdogxp.github.io/strongdog2",
          "https://strongdogxp.github.io/strongdog3",
        ],
        "mathcordxp.github.io": [],
      };
    </script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBh-VnGiP4qZD0r14gfn9dr77GwtslpTqU",
        authDomain: "strongdog-auth.firebaseapp.com",
        databaseURL: "https://strongdog-auth-default-rtdb.firebaseio.com",
        projectId: "strongdog-auth",
        storageBucket: "strongdog-auth.appspot.com",
        messagingSenderId: "936276282572",
        appId: "1:936276282572:web:a802b7f609381ff9428669",
        measurementId: "G-0YLTCV2MMS",
      };

      firebase.initializeApp(firebaseConfig);
      window.auth = firebase.auth();
      window.db = firebase.firestore();
      window.rtdb = firebase.database();
    </script>

    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-D88TDDVPGJ"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-D88TDDVPGJ");
    </script>

    <script>
      window.addEventListener("DOMContentLoaded", function () {
        if (!document.getElementById("autoSaveModal")) {
          var modal = document.createElement("div");
          modal.id = "autoSaveModal";
          modal.style.cssText =
            "display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; z-index: 3000;";
          var modalContent = document.createElement("div");
          modalContent.style.cssText =
            "background: #333; padding: 20px; border-radius: 5px; text-align: center; max-width: 90%; color: #fff;";
          var p = document.createElement("p");
          p.textContent =
            "Would you like to load your auto-save?\nIf you do not load it now, you must manually enable auto saves in the save menu.";
          p.style.whiteSpace = "pre-wrap";
          var btnYes = document.createElement("button");
          btnYes.id = "autoSaveYes";
          btnYes.textContent = "Yes";
          btnYes.style.cssText =
            "margin-right: 10px; padding: 10px 20px; background: orange; border: none; border-radius: 5px; cursor: pointer;";
          var btnNo = document.createElement("button");
          btnNo.id = "autoSaveNo";
          btnNo.textContent = "No";
          btnNo.style.cssText =
            "padding: 10px 20px; background: gray; border: none; border-radius: 5px; cursor: pointer;";
          modalContent.appendChild(p);
          modalContent.appendChild(btnYes);
          modalContent.appendChild(btnNo);
          modal.appendChild(modalContent);
          document.body.appendChild(modal);
        }

        function setCookie(name, value, days) {
          const date = new Date();
          date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
          document.cookie = `${name}=${value};expires=${date.toUTCString()};path=/`;
        }
        function getCookie(name) {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(";").shift();
          return "";
        }

        function getAllLocalStorageData() {
          var data = {};
          for (var i = 0; i < localStorage.length; i++) {
            var key = localStorage.key(i);
            data[key] = localStorage.getItem(key);
          }
          return data;
        }
        function setAllLocalStorageData(data) {
          localStorage.clear();
          for (var key in data) {
            localStorage.setItem(key, data[key]);
          }
        }
        function autoSaveData() {
          if (!window.currentUserId) return;
          var data = getAllLocalStorageData();
          var title = "Auto Save";
          var description = "Auto-saved on " + new Date().toLocaleString();
          window.db
            .collection("users")
            .doc(window.currentUserId)
            .collection("saves")
            .doc("slot3")
            .set({
              title: title,
              description: description,
              localStorageData: data,
            });
        }
        function loadAutoSave() {
          if (!window.currentUserId) return;
          window.db
            .collection("users")
            .doc(window.currentUserId)
            .collection("saves")
            .doc("slot3")
            .get()
            .then(function (doc) {
              if (doc.exists && doc.data() && doc.data().localStorageData) {
                setAllLocalStorageData(doc.data().localStorageData);
                alert("Auto-save loaded!");
              } else {
                alert("No auto-save data found in Firebase.");
              }
            });
        }
        function showAutoSaveModal() {
          var modal = document.getElementById("autoSaveModal");
          if (modal) modal.style.display = "flex";
        }
        function hideAutoSaveModal() {
          var modal = document.getElementById("autoSaveModal");
          if (modal) modal.style.display = "none";
        }

        var autoSaveYes = document.getElementById("autoSaveYes");
        var autoSaveNo = document.getElementById("autoSaveNo");
        if (autoSaveYes) {
          autoSaveYes.addEventListener("click", function () {
            hideAutoSaveModal();
            setCookie("autoSaveEnabled", "true", 9999);
            loadAutoSave();
          });
        }
        if (autoSaveNo) {
          autoSaveNo.addEventListener("click", function () {
            hideAutoSaveModal();
            setCookie("autoSaveEnabled", "false", 9999);
          });
        }

        window.auth.onAuthStateChanged(function (user) {
          if (user) {
            window.currentUserId = user.uid;
            var autoEnabled = getCookie("autoSaveEnabled");
            if (!autoEnabled) {
              window.db
                .collection("users")
                .doc(window.currentUserId)
                .collection("saves")
                .doc("slot3")
                .get()
                .then(function (doc) {
                  if (doc.exists && doc.data() && doc.data().localStorageData) {
                    showAutoSaveModal();
                  } else {
                    setCookie("autoSaveEnabled", "true", 9999);
                    if (!getCookie("autoSaveDone")) {
                      autoSaveData();
                      setCookie("autoSaveDone", "true", 1);
                    }
                  }
                });
            } else if (autoEnabled === "true" && !getCookie("autoSaveDone")) {
              autoSaveData();
              setCookie("autoSaveDone", "true", 1);
            }
          }
        });
      });
    </script>
  </head>

  <body>
    <div
      id="secretLink"
      title="Secret Menu"
      style="
        position: absolute;
        top: 10px;
        right: 10px;
        width: 10px;
        height: 10px;
        cursor: pointer;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      "
    ></div>
    <script>
      window.addEventListener("load", function () {
        const secretLink = document.getElementById("secretLink");
        secretLink.addEventListener("click", function () {
          window.location.href = "secret-menu.html";
        });
      });
    </script>

    <div class="navbar">
      <div class="menu-icon" id="menuIcon">☰</div>
      <a href="index.html" class="logo">StrongDog<span class="xp">XP</span></a>

      <div class="search-container">
        <input
          type="text"
          class="search-bar"
          placeholder="Search for games..."
          id="searchInput"
          autocomplete="off"
        />
        <div class="search-results" id="searchResults"></div>
      </div>
    </div>

    <div class="updates-text-container">
      <p class="updates-paragraph-text">
        Dont forget to join the discord!
      </p>
    </div>

    <div class="modal" id="popupModal">
      <div class="modal-content">
        <span class="modal-close" id="closeModal">×</span>
        <p>
          The StrongDog Discord server is a place for StrongDog users to chill,
          play games together, request ideas, and have fun!
        </p>
        <p>
          If you want to help with StrongDog, there's a chat where you can get
          help downloading games, and you can upload games you download to add
          to StrongDog! (You WILL get credit.)
        </p>
        <p>
          Ready to join? Click
          <a href="https://discord.gg/pWjfQ4Sz5c" target="_blank">here</a>
          to join the Discord server!
        </p>
      </div>
    </div>

    <h2 id="topGameHeader" style="text-align: center">
      <strong>Top 20</strong>
    </h2>
    <div class="games-grid" id="topGameList"></div>

    <div class="section-header" id="favoritesHeader" style="display: none">
      <h2 style="text-align: center"><strong>Favorites</strong></h2>
    </div>
    <div class="games-grid" id="favoritesGameList" style="display: none"></div>

    <div class="section-header">
      <h2 style="text-align: center"><strong>All</strong></h2>
      <span class="edit-button" id="editAllButton">✏️</span>
    </div>
    <div class="games-grid" id="allGameList"></div>

    <h2 style="text-align: center"><strong>StrongDogXP LLC</strong></h2>
    <div class="news-container">
      <div class="news">
        <div class="credits-item">
          <div class="credits-role">CEO</div>
          <div class="credits-names">
            <a
              href="https://github.com/jman1593"
              target="_blank"
              class="credits-link"
              >Joshua Pettit</a
            >
          </div>
        </div>
        <div class="credits-item">
          <div class="credits-role">Developers</div>
          <div class="credits-names">
            <a
              href="https://github.com/JamesMeadows4"
              target="_blank"
              class="credits-link"
              >James Meadows</a
            >
            <span>|</span>
            <a
              href="https://github.com/jman1593"
              target="_blank"
              class="credits-link"
              >Joshua Pettit</a
            >
            <span>|</span>
            <a
              href="https://playfab-pal.co.uk/"
              target="_blank"
              class="credits-link"
              >Aaron B</a
            >
          </div>
        </div>
        <div class="credits-item">
          <div class="credits-role">Game Downloaders</div>
          <div class="credits-names">
            <a
              href="https://github.com/jman1593"
              target="_blank"
              class="credits-link"
              >Joshua Pettit</a
            >
            <span>|</span>
            <a
              href="https://maxwellstevenson.com"
              target="_blank"
              class="credits-link"
              >Maxwell Stevenson</a
            >
          </div>
        </div>
      </div>
    </div>

    <h2 class="alternate-links-title">Alternate Links</h2>
    <div class="alternate-links-container" id="alternate-links-container"></div>
    <h2 class="alternate-links-title">
      Exclusive links available on the StrongDogXP
      <a href="https://discord.gg/pWjfQ4Sz5c">Discord server</a>!
    </h2>

    <div class="slide-menu" id="slideMenu" style="transform: translateX(-100%)">
      <div class="categories">
        <a href="favs.html" class="option-link">Favorites</a>
        <a href="#" id="randomGame" class="option-link">Random Game</a>
        <a href="#" id="blockLanschool" class="option-link">Block Lanschool</a>
        <a href="about.html" class="option-link"
          >About | Bugs | Request Games</a
        >
        <a href="./save/" class="option-link"
          >Save manager</a
        >
        <a href="https://discord.gg/pWjfQ4Sz5c" class="option-link"
          >Discord Server</a
        >
      </div>
    </div>

    <div
      class="custom-slide-menu"
      id="customSlideMenu"
      style="transform: translateX(-100%)"
    >
      <div class="custom-options" style="padding: 20px">
        <div class="toggle-option" style="margin-bottom: 10px">
          <label for="top20Toggle">Show Top 20</label>
          <input type="checkbox" id="top20Toggle" checked />
        </div>
        <div class="toggle-option" style="margin-bottom: 10px">
          <label for="favoritesToggle">Show Favorites</label>
          <input type="checkbox" id="favoritesToggle" />
        </div>
        <div class="slider-option" style="margin-bottom: 10px">
          <label
            for="cardSizeSlider"
            style="color: white; display: block; margin-bottom: 5px"
            >Card Size Adjustment</label
          >
          <input
            type="range"
            id="cardSizeSlider"
            min="-100"
            max="100"
            value="0"
            step="1"
            style="width: 100%"
          />
          <div style="text-align: center; color: white; margin-top: 5px">
            Value: <span id="cardSizeValue">0</span>
          </div>
        </div>
      </div>
    </div>

    <div class="overlay" id="favoritesOverlay"></div>
    <div class="popup-container" id="favoritesPopupContainer">
      <div class="popup" id="favoritesPopup">
        <p>You need to sign in to view your favorites.</p>
        <button id="favoritesOkButton">OK</button>
      </div>
    </div>
    <script>
      const alternateLinksContainer = document.getElementById(
        "alternate-links-container"
      );
      const alternateLinks = [
        "mastersite.org",
        "65a.org",
        "fundle.org",
        "gametree.net",
        "hateroll.com",
        "strongdogunblocked.github.io",
        "weakcatxp.github.io",
        "gametreexp.github.io",
        "mathcordxp.github.io",
        "strongdogxp.github.io",
        "jman1593.github.io",
        "strongdog-1.vercel.app",
        "mathcord.com",
        "strongdog.com",
      ];
      alternateLinks.forEach((link) => {
        const a = document.createElement("a");
        a.href = `https://${link}`;
        a.target = "_blank";
        a.textContent = link;
        a.classList.add("alternate-link");
        alternateLinksContainer.appendChild(a);
      });
    </script>
    <script type="module">
      import games from "./cards-data.js";
      import { targetUrl } from "./appscript.js";

      function normalizeGameName(name) {
        return name
          .toLowerCase()
          .replace(/\s+/g, "")
          .replace(/[^a-z0-9]/g, "");
      }

      function getTierAndProgressFromXP(xp) {
        const baseXPNeeded = 50;
        const increasePerTier = 200;
        const exponentialMultiplier = 1.2;
        const levelsPerTier = 5;
        const capTier = 10;
        let level = 1;
        let tier = 1;
        let xpNeeded = baseXPNeeded;
        while (xp >= xpNeeded) {
          xp -= xpNeeded;
          if (tier < capTier) {
            if (level % levelsPerTier === 0) {
              tier++;
              xpNeeded = Math.round(xpNeeded * exponentialMultiplier);
            }
          } else {
            if (level % levelsPerTier === 0) {
              xpNeeded += increasePerTier;
            }
          }
          level++;
        }
        return {
          level,
          tier,
          currentXP: xp,
          xpNeededForNext: xpNeeded,
        };
      }

      const numTopGames = 20;
      const topGameList = document.getElementById("topGameList");
      for (let i = 0; i < numTopGames; i++) {
        const ghostCard = document.createElement("div");
        ghostCard.classList.add("ghost-card");
        ghostCard.style.animation = `pulse 2s ${i / 15}s infinite`;
        topGameList.appendChild(ghostCard);
      }

      function fetchTopGames() {
        fetch(targetUrl, { method: "GET" })
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                "Network response was not ok: " + response.statusText
              );
            }
            return response.json();
          })
          .then((data) => {
            if (data && data.content) {
              const parsedData = JSON.parse(data.content);
              console.log("Parsed data:", parsedData);
              displayTopGames(parsedData);
            } else {
              console.error("Invalid data format:", data);
            }
          })
          .catch((error) => console.error("Error fetching top games:", error));
      }

      function displayTopGames(topData) {
        topGameList.innerHTML = "";
        let foundCount = 0;
        let index = 1;
        const displayedGameNames = new Set();
        while (foundCount < numTopGames && index < topData.length) {
          const row = topData[index];
          const gameName = row[0];
          const matchingCard = findMatchingCard(gameName);
          if (matchingCard) {
            if (!displayedGameNames.has(gameName)) {
              topGameList.appendChild(matchingCard.cloneNode(true));
              displayedGameNames.add(gameName);
              foundCount++;
            }
          } else {
            console.warn(`Card for "${gameName}" not found, skipping.`);
          }
          index++;
        }
        if (foundCount < numTopGames) {
          console.warn(
            `Could not fill all ${numTopGames} top slots. Found: ${foundCount}`
          );
        }
      }

      function findMatchingCard(gameName) {
        const formattedGameName = normalizeGameName(gameName);
        const allCards = document.querySelectorAll("#allGameList .card");
        for (let card of allCards) {
          const cardGameId = card.getAttribute("data-game-id");
          if (cardGameId === formattedGameName) {
            return card;
          }
        }
        return null;
      }

      fetchTopGames();

      function getPageNumberFromURL(url) {
        const regex = /(strongdog|mathcord|stroongdog)(\d*)/;
        const match = url.match(regex);
        if (match) {
          return match[2] === "" ? 1 : parseInt(match[2], 10);
        }
        return 1;
      }

      const siteMapping = window.siteMapping || {};

      function getCurrentSiteKey() {
        const currentURL = window.location.href;
        const keys = Object.keys(siteMapping).sort(
          (a, b) => b.length - a.length
        );
        for (const key of keys) {
          if (currentURL.includes(key)) return key;
        }
        return null;
      }

      function getAdjustedUrls(href, imgSrc, page) {
        let adjustedHref = href;
        let adjustedImgSrc = `./img/${imgSrc}`;
        const currentSiteKey = getCurrentSiteKey();
        if (currentSiteKey) {
          const currentSitePages = siteMapping[currentSiteKey];
          const pageNumberToURL = {};
          let currentPageNumber = getPageNumberFromURL(currentSiteKey);
          pageNumberToURL[currentPageNumber] = currentSiteKey;
          if (currentSitePages) {
            currentSitePages.forEach((url) => {
              const pNum = getPageNumberFromURL(url);
              pageNumberToURL[pNum] = url;
            });
          }
          if (page !== undefined && page !== currentPageNumber) {
            let adjustedBaseURL = pageNumberToURL[page];
            if (!adjustedBaseURL) {
              const currentOrigin = window.location.origin;
              adjustedBaseURL = `${currentOrigin}/strongdog${page}`;
            }
            const adjustedGameHref = href.replace(/^\.\//, "");
            adjustedHref = `${adjustedBaseURL}/${adjustedGameHref}`;
            const adjustedImgPath = imgSrc.replace(/^\.\//, "");
            adjustedImgSrc = `${adjustedBaseURL}/img/${adjustedImgPath}`;
          }
        } else {
          if (page !== undefined && page > 1) {
            const currentOrigin = window.location.origin;
            const adjustedBaseURL = `${currentOrigin}/strongdog${page}`;
            const adjustedGameHref = href.replace(/^\.\//, "");
            adjustedHref = `${adjustedBaseURL}/${adjustedGameHref}`;
            const adjustedImgPath = imgSrc.replace(/^\.\//, "");
            adjustedImgSrc = `${adjustedBaseURL}/img/${adjustedImgPath}`;
          }
        }
        return { adjustedHref, adjustedImgSrc };
      }

      function getCardHTML(gameObject) {
        const { href, imgSrc, name, page, id } = gameObject;
        const { adjustedHref, adjustedImgSrc } = getAdjustedUrls(
          href,
          imgSrc,
          page
        );
        const gameLink = `./play/?id=${id}`;
        const normalizedName = normalizeGameName(name);
        return `
          <a href="${gameLink}" class="card" data-game-id="${normalizedName}" data-page="${page}">
            <img src="${adjustedImgSrc}" alt="${name}">
            <figcaption>${name}</figcaption>
          </a>
        `;
      }

      const allGameListElement = document.getElementById("allGameList");
      const cardsHTMLArr = games.map((game) => getCardHTML(game));
      allGameListElement.innerHTML = cardsHTMLArr.join("");

      const searchInput = document.querySelector(".search-bar");
      const searchResults = document.getElementById("searchResults");
      if (searchInput && searchResults) {
        function updateSearchResults() {
          const searchText = searchInput.value.toLowerCase();
          const filteredGames = games
            .filter((g) => g.name.toLowerCase().includes(searchText))
            .slice(0, 7);
          searchResults.innerHTML = "";
          if (filteredGames.length === 0) {
            searchResults.style.display = "none";
            return;
          }
          filteredGames.forEach((game) => {
            const { id, imgSrc, name, page } = game;
            const { adjustedImgSrc } = getAdjustedUrls(game.href, imgSrc, page);
            const resultLink = document.createElement("a");
            resultLink.href = `./play/?id=${id}`;
            resultLink.innerHTML = `
              <img src="${adjustedImgSrc}" alt="${name}">
              <span>${name}</span>
            `;
            searchResults.appendChild(resultLink);
          });
          searchResults.style.display = "block";
        }
        searchInput.addEventListener("focus", updateSearchResults);
        searchInput.addEventListener("input", updateSearchResults);
        document.addEventListener("click", (event) => {
          if (
            !searchInput.contains(event.target) &&
            !searchResults.contains(event.target)
          ) {
            searchResults.style.display = "none";
          }
        });
      }

      const menuIcon = document.getElementById("menuIcon");
      const slideMenu = document.getElementById("slideMenu");
      const categories = slideMenu.querySelector(".categories");
      menuIcon.addEventListener("click", (event) => {
        event.stopPropagation();
        if (slideMenu.style.transform === "translateX(0%)") {
          slideMenu.style.transform = "translateX(-100%)";
        } else {
          slideMenu.style.transform = "translateX(0%)";
        }
      });
      window.addEventListener("click", (event) => {
        if (event.target !== menuIcon && !slideMenu.contains(event.target)) {
          slideMenu.style.transform = "translateX(-100%)";
        }
      });

      auth.onAuthStateChanged(async (user) => {
        if (user) {
          const userId = user.uid;
          const userDetailsContainer = document.createElement("div");
          userDetailsContainer.className = "user-details-container";
          const profileTopContainer = document.createElement("div");
          profileTopContainer.className = "profile-top-container";
          const profilePictureContainer = document.createElement("div");
          profilePictureContainer.className = "profile-picture-container";
          const profilePictureElement = document.createElement("img");
          profilePictureElement.className = "profile-picture";
          profilePictureContainer.appendChild(profilePictureElement);
          const usernameContainer = document.createElement("div");
          usernameContainer.className = "username-container";
          const usernameElement = document.createElement("p");
          usernameElement.className = "username-text";
          usernameContainer.appendChild(usernameElement);
          profileTopContainer.appendChild(profilePictureContainer);
          profileTopContainer.appendChild(usernameContainer);
          userDetailsContainer.appendChild(profileTopContainer);
          if (user.photoURL) {
            profilePictureElement.src = user.photoURL;
          } else {
            profilePictureElement.src = "img/default-avatar.png";
          }
          const userDocRef = db.collection("usernames").doc(userId);
          const userDoc = await userDocRef.get();
          if (userDoc.exists) {
            const userData = userDoc.data();
            usernameElement.textContent =
              userData.username || user.displayName || "Username";
          } else {
            usernameElement.textContent = user.displayName || "Username";
          }
          const xpRef = rtdb.ref(`xp/${userId}`);
          xpRef.once("value", (snapshot) => {
            let totalXP = snapshot.exists() ? snapshot.val() : 0;
            const { level, currentXP, xpNeededForNext } =
              getTierAndProgressFromXP(totalXP);
            const xpContainer = document.createElement("div");
            xpContainer.className = "xp-container";
            const xpLevelText = document.createElement("div");
            xpLevelText.className = "xp-level-text";
            xpLevelText.textContent = `Level ${level}`;
            const xpBar = document.createElement("div");
            xpBar.className = "xp-bar";
            const xpBarFill = document.createElement("div");
            xpBarFill.className = "xp-bar-fill";
            xpBarFill.style.width = `${(currentXP / xpNeededForNext) * 100}%`;
            const xpBarText = document.createElement("div");
            xpBarText.className = "xp-bar-text";
            xpBarText.textContent = `${currentXP}/${xpNeededForNext}`;
            xpBar.appendChild(xpBarFill);
            xpBar.appendChild(xpBarText);
            xpContainer.appendChild(xpLevelText);
            xpContainer.appendChild(xpBar);
            userDetailsContainer.appendChild(xpContainer);
            profilePictureContainer.addEventListener("click", () => {
              window.location.href = "settings.html";
            });
            slideMenu.insertBefore(userDetailsContainer, categories);
            const logoutLink = document.createElement("a");
            logoutLink.href = "#";
            logoutLink.className = "option-link";
            logoutLink.textContent = "Log Out";
            logoutLink.style.backgroundColor = "#dc3545";
            logoutLink.style.color = "white";
            logoutLink.addEventListener("click", (e) => {
              e.preventDefault();
              auth
                .signOut()
                .then(() => window.location.reload())
                .catch((error) => console.error("Error signing out:", error));
            });
            const favoritesLink = categories.querySelector(
              'a[href="favs.html"]'
            );
            categories.insertBefore(logoutLink, favoritesLink);
            db.collection("access")
              .doc(user.uid)
              .get()
              .then((accessDoc) => {
                if (accessDoc.exists) {
                  const accessData = accessDoc.data();
                  if (accessData.tester === true) {
                    const testGamesLink = document.createElement("a");
                    testGamesLink.href = "test.html";
                    testGamesLink.className = "option-link";
                    testGamesLink.textContent = "Test Games";
                    testGamesLink.style.backgroundColor = "#28a745";
                    testGamesLink.style.color = "white";
                    testGamesLink.style.marginTop = "10px";
                    testGamesLink.addEventListener("mouseover", () => {
                      testGamesLink.style.backgroundColor = "#218838";
                    });
                    testGamesLink.addEventListener("mouseout", () => {
                      testGamesLink.style.backgroundColor = "#28a745";
                    });
                    categories.insertBefore(testGamesLink, favoritesLink);
                  }
                }
              })
              .catch((err) =>
                console.error("Error checking 'access' collection:", err)
              );
          });
        } else {
          const userDetailsContainer = document.createElement("div");
          userDetailsContainer.className = "user-details-container";
          const notLoggedInContainer = document.createElement("div");
          notLoggedInContainer.className = "username-container";
          const notLoggedInText = document.createElement("p");
          notLoggedInText.className = "username-text";
          notLoggedInText.textContent = "Not logged in";
          notLoggedInContainer.appendChild(notLoggedInText);
          const loginButton = document.createElement("button");
          loginButton.textContent = "Log In";
          loginButton.style.backgroundColor = "#007bff";
          loginButton.style.color = "white";
          loginButton.style.border = "none";
          loginButton.style.padding = "10px 20px";
          loginButton.style.fontSize = "16px";
          loginButton.style.borderRadius = "5px";
          loginButton.style.cursor = "pointer";
          loginButton.style.marginTop = "5px";
          loginButton.addEventListener("click", function () {
            window.location.href = "login.html";
          });
          userDetailsContainer.style.display = "flex";
          userDetailsContainer.style.flexDirection = "column";
          userDetailsContainer.style.alignItems = "center";
          userDetailsContainer.style.paddingBlock = "20px";
          userDetailsContainer.appendChild(notLoggedInContainer);
          userDetailsContainer.appendChild(loginButton);
          slideMenu.insertBefore(userDetailsContainer, categories);
        }
        const randomGameLink = categories.querySelector("#randomGame");
        if (randomGameLink) {
          randomGameLink.addEventListener("click", (e) => {
            e.preventDefault();
            if (games.length > 0) {
              const randomIndex = Math.floor(Math.random() * games.length);
              const selectedGame = games[randomIndex];
              window.location.href = `./play/?id=${selectedGame.id}`;
            } else {
              console.error("No game paths available to pick from.");
            }
          });
        }
        const blockLanSchoolLink = categories.querySelector("#blockLanschool");
        if (blockLanSchoolLink) {
          blockLanSchoolLink.addEventListener("click", (e) => {
            e.preventDefault();
            const url = window.location.href;
            const newTab = window.open();
            if (!newTab) {
              console.warn("Popup blocked—please allow popups!");
              return;
            }
            newTab.document.write(`
              <html>
                <body style="margin: 0; height: 100vh;">
                  <iframe src="${url}" style="border: none; width: 100%; height: 100%;"></iframe>
                </body>
              </html>
            `);
            newTab.document.close();
          });
        }
      });

      const editAllButton = document.getElementById("editAllButton");
      const customSlideMenu = document.getElementById("customSlideMenu");
      editAllButton.addEventListener("click", (event) => {
        event.stopPropagation();
        slideMenu.style.transform = "translateX(-100%)";
        if (customSlideMenu.style.transform === "translateX(0%)") {
          customSlideMenu.style.transform = "translateX(-100%)";
        } else {
          customSlideMenu.style.transform = "translateX(0%)";
        }
      });
      window.addEventListener("click", (e) => {
        if (
          e.target !== editAllButton &&
          !customSlideMenu.contains(e.target) &&
          e.target.id !== "editAllButton"
        ) {
          customSlideMenu.style.transform = "translateX(-100%)";
        }
      });

      const top20Toggle = document.getElementById("top20Toggle");
      function setCookie(name, value, days) {
        const date = new Date();
        date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
        document.cookie = `${name}=${value};expires=${date.toUTCString()};path=/`;
      }
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(";").shift();
        return "";
      }
      const top20Disabled = getCookie("top20Disabled") === "true";
      top20Toggle.checked = !top20Disabled;
      const topGameHeader = document.getElementById("topGameHeader");
      if (top20Disabled) {
        topGameList.style.display = "none";
        topGameHeader.style.display = "none";
      }
      top20Toggle.addEventListener("change", function () {
        if (top20Toggle.checked) {
          topGameList.style.display = "flex";
          topGameHeader.style.display = "block";
          setCookie("top20Disabled", "false", 365);
        } else {
          topGameList.style.display = "none";
          topGameHeader.style.display = "none";
          setCookie("top20Disabled", "true", 365);
        }
      });

      const favoritesToggle = document.getElementById("favoritesToggle");
      const favoritesHeader = document.getElementById("favoritesHeader");
      const favoritesGameList = document.getElementById("favoritesGameList");
      let favoritesCookie = getCookie("favoritesDisabled");
      if (favoritesCookie === "") {
        favoritesCookie = "true";
      }
      const favoritesDisabled = favoritesCookie === "true";
      favoritesToggle.checked = !favoritesDisabled;
      if (favoritesDisabled) {
        favoritesHeader.style.display = "none";
        favoritesGameList.style.display = "none";
      } else {
        favoritesHeader.style.display = "block";
        favoritesGameList.style.display = "flex";
      }
      favoritesToggle.addEventListener("change", function () {
        if (favoritesToggle.checked) {
          favoritesHeader.style.display = "block";
          favoritesGameList.style.display = "flex";
          setCookie("favoritesDisabled", "false", 365);
          loadFavorites();
        } else {
          favoritesHeader.style.display = "none";
          favoritesGameList.style.display = "none";
          setCookie("favoritesDisabled", "true", 365);
        }
      });

      function loadFavorites() {
        const numFavoritePlaceholders = 10;
        favoritesGameList.innerHTML = "";
        for (let i = 0; i < numFavoritePlaceholders; i++) {
          const ghostCard = document.createElement("div");
          ghostCard.classList.add("ghost-card");
          ghostCard.style.animation = `pulse 2s ${i / 15}s infinite`;
          favoritesGameList.appendChild(ghostCard);
        }
        auth.onAuthStateChanged(function (user) {
          if (user) {
            fetchFavorites(user.uid);
          } else {
            showFavoritesPopup();
            favoritesGameList.innerHTML =
              '<p class="no-favorites">No favorites yet!</p>';
          }
        });
      }

      async function fetchFavorites(userId) {
        try {
          const favDoc = await db.collection("favs").doc(userId).get();
          if (favDoc.exists) {
            const favoritesData = favDoc.data();
            console.log("Favorites data retrieved:", favoritesData);
            displayFavorites(favoritesData);
          } else {
            favoritesGameList.innerHTML =
              '<p class="no-favorites">No favorites yet!</p>';
          }
        } catch (error) {
          console.error("Error fetching favorites:", error);
          favoritesGameList.innerHTML =
            '<p class="no-favorites">Error loading favorites.</p>';
        }
      }

      function displayFavorites(favorites) {
        favoritesGameList.innerHTML = "";
        let hasFavorites = false;
        Object.keys(favorites).forEach((gameId) => {
          if (favorites[gameId]) {
            const game = games.find(
              (g) => parseInt(g.id, 10) === parseInt(gameId, 10)
            );
            if (game) {
              hasFavorites = true;
              favoritesGameList.innerHTML += getCardHTML(game);
            } else {
              console.warn(`Game with ID ${gameId} not found in games data.`);
            }
          }
        });
        if (!hasFavorites) {
          favoritesGameList.innerHTML =
            '<p class="no-favorites">No favorites yet!</p>';
        }
      }

      function showFavoritesPopup() {
        const popupContainer = document.getElementById(
          "favoritesPopupContainer"
        );
        const overlay = document.getElementById("favoritesOverlay");
        popupContainer.classList.add("active");
        overlay.style.display = "block";
      }

      function hideFavoritesPopup() {
        const popupContainer = document.getElementById(
          "favoritesPopupContainer"
        );
        const overlay = document.getElementById("favoritesOverlay");
        popupContainer.classList.remove("active");
        overlay.style.display = "none";
      }

      document.addEventListener("DOMContentLoaded", function () {
        if (favoritesToggle.checked) {
          loadFavorites();
        }
      });

      document
        .getElementById("favoritesOkButton")
        .addEventListener("click", function () {
          hideFavoritesPopup();
        });

      document.addEventListener("DOMContentLoaded", () => {
        const page1Link = document.getElementById("page1-link");
        const page2Link = document.getElementById("page2-link");
        if (!page1Link || !page2Link) return;
        const hostname = window.location.hostname;
        const linkMap = {
          "jman1593.github.io": {
            page1: "/#",
            page2: "/strongdog2/index.html",
          },
          "strongdog-1.vercel.app": {
            page1: "https://strongdog-1.vercel.app",
            page2: "https://strongdog2.vercel.app",
          },
          "strongdog2.vercel.app": {
            page1: "https://strongdog-1.vercel.app",
            page2: "https://strongdog2.vercel.app",
          },
          "strongdog.netlify.app": {
            page1: "https://strongdog.netlify.app",
            page2: "https://strongdog2.netlify.app",
          },
          "strongdog2.netlify.app": {
            page1: "https://strongdog.netlify.app",
            page2: "https://strongdog2.netlify.app",
          },
          "mathcord.netlify.app": {
            page1: "https://mathcord.netlify.app",
            page2: "https://mathcord2.netlify.app",
          },
          "mathcord2.netlify.app": {
            page1: "https://mathcord.netlify.app",
            page2: "https://mathcord2.netlify.app",
          },
          "strongdog.onrender.com": {
            page1: "https://strongdog.onrender.com",
            page2: "https://strongdog2.onrender.com",
          },
          "stroongdog.netlify.app": {
            page1: "https://stroongdog.netlify.app",
            page2: "https://stroongdog2.netlify.app",
          },
          "stroongdog2.netlify.app": {
            page1: "https://stroongdog.netlify.app",
            page2: "https://stroongdog2.netlify.app",
          },
        };
        for (const key in linkMap) {
          if (hostname.includes(key)) {
            page1Link.href = linkMap[key].page1;
            page2Link.href = linkMap[key].page2;
            break;
          }
        }
      });

      const cardSizeSlider = document.getElementById("cardSizeSlider");
      const cardSizeValue = document.getElementById("cardSizeValue");
      function updateCardSizes() {
        const sliderVal = parseInt(cardSizeSlider.value, 10);
        cardSizeValue.textContent = sliderVal;
        const newSize = 120 + sliderVal;
        const newGap = Math.max(10 + sliderVal / 4, 5);
        const newBorderRadius =
          sliderVal < 0 ? Math.max(15 + sliderVal * 0.13, 2) : 15;
        const cards = document.querySelectorAll(".card, .ghost-card");
        cards.forEach((card) => {
          card.style.width = newSize + "px";
          card.style.height = newSize + "px";
          card.style.borderRadius = newBorderRadius + "px";
        });
        const gamesGrids = document.querySelectorAll(".games-grid");
        gamesGrids.forEach((grid) => {
          grid.style.gap = newGap + "px";
        });
        setCookie("cardSize", sliderVal, 365);
      }
      cardSizeSlider.addEventListener("input", updateCardSizes);
      const savedSize = getCookie("cardSize");
      if (savedSize !== "") {
        cardSizeSlider.value = savedSize;
        updateCardSizes();
      }
    </script>
  </body>
</html>